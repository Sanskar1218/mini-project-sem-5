<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Forecast Demo</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1>Stock Forecast Demo</h1>
    <div class="row">
      <button id="btn-health">Check Health</button>
      <button id="btn-stocks">List Stocks</button>
    </div>
    <section id="stocks" class="card hidden">
      <h2>Available Stocks</h2>
      <ul id="stocks-list"></ul>
    </section>

    <section id="forecast" class="card">
      <h2>Request Forecast</h2>
      <label>Symbol
        <select id="symbol">
          <option value="RELIANCE-EQ">RELIANCE-EQ</option>
          <option value="TCS-EQ">TCS-EQ</option>
          <option value="INFY-EQ">INFY-EQ</option>
        </select>
      </label>
      <label>Use Angel One
        <input type="checkbox" id="use-angel" checked />
      </label>
      <label>Use Mock (fast)
        <input type="checkbox" id="use-mock" />
      </label>
      <label>TOTP (if using Angel One)
        <input type="text" id="totp" placeholder="Enter 6-digit TOTP" maxlength="6" />
      </label>
      <label>Days
        <input type="number" id="days" value="7" min="1" max="30" />
      </label>
      <button id="btn-forecast">Get Forecast</button>
      <pre id="forecast-output" class="output"></pre>
    </section>

    <section id="logs" class="card">
      <h2>Logs</h2>
      <pre id="log-output" class="output"></pre>
    </section>
  </main>

  <script>
    const API_BASE = 'http://127.0.0.1:5000';
    const log = (msg) => { const el = document.getElementById('log-output'); el.textContent = (el.textContent ? el.textContent + '\n' : '') + msg; }

    document.getElementById('btn-health').addEventListener('click', async () => {
      try {
        const r = await fetch(API_BASE + '/health');
        const txt = await r.text();
        log('/health -> ' + txt);
        alert('Health: ' + txt);
      } catch (e) { log('health error ' + e); alert('Health check failed: ' + e); }
    });

    document.getElementById('btn-stocks').addEventListener('click', async () => {
      try {
        const r = await fetch(API_BASE + '/api/stocks');
        const j = await r.json();
        const list = document.getElementById('stocks-list');
        list.innerHTML = '';
        j.stocks.forEach(s => { const li = document.createElement('li'); li.textContent = s.symbol + ' â€” ' + s.name; list.appendChild(li); });
        document.getElementById('stocks').classList.remove('hidden');
        log('/api/stocks loaded');
      } catch (e) { log('stocks error ' + e); alert('Stocks fetch failed: ' + e); }
    });

    document.getElementById('btn-forecast').addEventListener('click', async () => {
      const symbol = document.getElementById('symbol').value;
      const totp = document.getElementById('totp').value;
      const use_angel = document.getElementById('use-angel').checked;
      const days = Number(document.getElementById('days').value) || 7;
      const payload = { totp, symbol, use_angelone: use_angel, forecast_days: days };
      log('requesting forecast ' + JSON.stringify(payload));
      try {
        const useMock = document.getElementById('use-mock').checked;
        const endpoint = useMock ? '/api/forecast-mock' : '/api/forecast';
        const url = API_BASE + endpoint;
        log('POST -> ' + url);
        const r = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        log('response status: ' + r.status);
        const j = await r.json();
        document.getElementById('forecast-output').textContent = JSON.stringify(j, null, 2);
        log('forecast returned');
      } catch (e) {
        log('forecast error ' + e + ' (url: ' + (typeof url !== 'undefined' ? url : 'unknown') + ')');
        alert('Forecast request failed: ' + e);
      }
    });
  </script>
</body>
</html>